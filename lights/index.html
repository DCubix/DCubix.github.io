<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Lights</title>
	</head>
	<body>
		<style type="text/css">
			body, html {
				background: #444;
				width: 100%;
				height: 100%;
				margin: 0;
			}
			body {
				display: flex;
				align-items: center;
				justify-content: center;
			}
		</style>

		<script type="text/javascript" src="./fx.js"></script>
		<script type="text/javascript">
			Fx.create(640, 480, function(ass) {
				ass.addImage("ball", "./ball.png");
				ass.addImage("balln", "./balln.png");
			});

			let ents = Fx.entities;
			let im = Fx.input;
			let assets = Fx.assets;

			const GRAVITY = 0.65;
			const BOUNCE = 0.9;
			const FRICTION = 0.98;

			ents.create(["ball_spawner"]);

			let la = ents.create(["light"]);
			la.x = 128;
			la.y = 240;
			la.color = [1.0, 0.2, 0.0];
			la.radius = 2.0;

			let lb = ents.create(["light"]);
			lb.x = 518;
			lb.y = 240;
			lb.color = [0.0, 0.2, 1.0];
			lb.radius = 2.0;

			// let lc = ents.create(["light"]);
			// lb.x = 320;
			// lb.y = 240;
			// lb.color = [1.0, 0.9, 0.9];
			// lb.radius = 2.0;

			ents.registerBehavior("ball_spawner", {
				update: function(dt) {
					if (im.mousePressed(0)) {
						let ent = ents.create(["sprite", "normal", "ball", "ball_collision"]);
						let pos = im.mousePosition();
						ent.x = pos[0];
						ent.y = pos[1];
						ent.ox = ent.x - (Math.random() * 2.0 - 1.0) * 30.0;
						ent.oy = ent.y - (Math.random() * 2.0 - 1.0) * 30.0;
						ent.rotation = 0;
						ent.diffuse = assets.get("ball");
						ent.normal = assets.get("balln");

						ent.originX = 0.5;
						ent.originY = 0.5;
						ent.scaleX = 0.25;
						ent.scaleY = 0.25;
						ent.color = [
							0.2 + Math.random() * 0.8,
							0.2 + Math.random() * 0.8,
							0.2 + Math.random() * 0.8,
							1.0
						];
						ent.life = 10.0;
					}
				}
			});

			ents.registerBehavior("ball", {
				update: function(b, dt) {
					let vx = (b.x - b.ox) * FRICTION,
						vy = (b.y - b.oy) * FRICTION;

					b.ox = b.x;
					b.oy = b.y;
					b.x += vx;
					b.y += (vy + GRAVITY);
					b.rotation += vx * dt * Math.PI;
				}
			});

			ents.registerBehavior("ball_collision", {
				update: function(b, dt) {
					let vx = (b.x - b.ox) * FRICTION,
						vy = (b.y - b.oy) * FRICTION;

					let sz = 256 * 0.125;
					if (b.x > 640 - sz) {
						b.x = 640 - sz;
						b.ox = b.x + vx * BOUNCE;
					} else if (b.x < sz) {
						b.x = sz;
						b.ox = b.x + vx * BOUNCE;
					}
					
					if (b.y > 480 - sz) {
						b.y = 480 - sz;
						b.oy = b.y + vy * BOUNCE;
					} else if (b.y < sz) {
						b.y = sz;
						b.oy = b.y + vy * BOUNCE;
					}
				}
			});
		</script>
	</body>
</html>