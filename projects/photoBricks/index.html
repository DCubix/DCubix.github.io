<!DOCTYPE html>
<html>
	<head>
		<title>Photo Bricks</title>
		<link rel="stylesheet" type="text/css" href="../../semantic/semantic.min.css">
	</head>
	<body>
		<style type="text/css">
			* { margin: 0; padding: 0; }
			body, html {
				width: 100%;
				height: 100%;
			}
			#pb {
				position: absolute;
				width: 100%;
				height: 100%;
				z-index: 1;
			}
			.floating {
				position: absolute;
				width: 320px;
				z-index: 10;
				left: 10px;
				top: 10px;
				background: #fff;
				padding: 12px;
				box-sizing: border-box;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
			}
		</style>
		

		<script
			src="https://code.jquery.com/jquery-3.1.1.min.js"
			integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
			crossorigin="anonymous"></script>
		<script src="../../semantic/components/accordion.min.js"></script>
		<script src="../../semantic/semantic.min.js"></script>
		<script language='javascript'>
			$(document).ready(function(){
				$('.ui.accordion').accordion();
			});
			
		</script>
		<canvas id="pb" width="100" height="100">
			Error
		</canvas>
		<div class="ui form floating">
			<div class="ui medium header">Photo Bricks</div>
			<div class="ui accordion">
				<div class="active title">
					<i class="dropdown icon"></i>
					General
				</div>
				<div class="active content">
					<div class="transition visible">
						<div>
							<label for="file" class="ui icon button fluid">
								<i class="file icon"></i>
								Select File
							</label>
							<input type="file" id="file" style="display:none">
						</div>
						<div class="ui horizontal divider">Or</div>
						<div class="ui input fluid">
							<input id="in_url" type="text" placeholder="From URL">
						</div>
						<div class="ui small header">Preview</div>
						<img id="out_preview" class="ui small bordered image rounded fluid" src="../../img/image.png">
					</div>
				</div>
				<div class="title">
					<i class="dropdown icon"></i>
					Pixel Data
				</div>
				<div class="content">
					<div class="transition hidden">
						<div class="ui checkbox">
							<input id="chk_colorquant" type="checkbox">
							<label>Use Palette</label>
						</div>
						<p>Palette</p>
						<select id="palettes" class="ui dropdown"></select>
					</div>
				</div>
			</div>
			<br>
			<button id="btn_gen" class="ui positive fluid button">
				<i class="cog icon"></i>
				Generate
			</button>
			<div id="gen_loader" class="ui dimmer">
				<div class="ui loader"></div>
			</div>
		</div>

		<script id="brick_vs" type="text/x-vertex">
			precision highp float;
			attribute vec3 vPosition;
			attribute vec2 vUV;
			attribute vec3 vNormal;

			uniform mat4 mProjection;
			uniform mat4 mView;
			uniform mat4 mModel;

			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUV;

			void main() {
				mat4 mModelView = mView * mModel;
				vec4 pos = mModelView * vec4(vPosition, 1.0);
				gl_Position = mProjection * pos;
				oPosition = pos;
				oNormal = normalize(mModelView * vec4(vNormal, 0.0)).xyz;
				oUV = vUV;
			}
		</script>

		<script id="brick_fs" type="text/x-fragment">
			precision mediump float;
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUV;

			uniform vec3 uColor;
			uniform vec3 uLightDir;

			void main() {
				vec3 N = normalize(oNormal);
				vec3 V = normalize(-oPosition.xyz);
				vec3 L = normalize(-uLightDir);
				float nl = max(dot(N, L), 0.0) + 0.2;
				float spec = pow(max(0.0, dot(reflect(-L, N), V)), 32.0);
				gl_FragColor = vec4(uColor * nl + spec, 1.0);
			}
		</script>

		<script id="brick" type="text/plain">
			v 0.490000 1.000000 -0.490000
			v 0.490000 1.000000 0.490000
			v -0.490000 1.000000 0.490000
			v -0.490000 1.000000 -0.490000
			v 0.000003 1.166667 -0.284085
			v 0.000003 1.156667 -0.294438
			v -0.147226 1.156667 -0.254988
			v -0.142049 1.166667 -0.246022
			v -0.255004 1.156667 -0.147209
			v -0.246039 1.166667 -0.142033
			v -0.294454 1.156667 0.000019
			v -0.284101 1.166667 0.000019
			v -0.255004 1.156667 0.147248
			v -0.246039 1.166667 0.142071
			v -0.147226 1.156667 0.255026
			v -0.142049 1.166667 0.246060
			v 0.000003 1.156667 0.294476
			v 0.000003 1.166667 0.284123
			v 0.147231 1.156667 0.255026
			v 0.142055 1.166667 0.246061
			v 0.255010 1.156667 0.147248
			v 0.246044 1.166667 0.142071
			v 0.294460 1.156667 0.000019
			v 0.284107 1.166667 0.000019
			v 0.255010 1.156667 -0.147209
			v 0.246044 1.166667 -0.142033
			v 0.147231 1.156667 -0.254988
			v 0.142055 1.166667 -0.246022
			v 0.000003 1.010000 -0.294438
			v 0.000003 1.000000 -0.304790
			v -0.158607 1.000000 -0.262291
			v -0.147226 1.010000 -0.254988
			v -0.262307 1.000000 -0.158591
			v -0.255004 1.010000 -0.147209
			v -0.304807 1.000000 0.000019
			v -0.294454 1.010000 0.000019
			v -0.262307 1.000000 0.158629
			v -0.255004 1.010000 0.147248
			v -0.158608 1.000000 0.262329
			v -0.147226 1.010000 0.255026
			v 0.000003 1.000000 0.304829
			v 0.000003 1.010000 0.294476
			v 0.158614 1.000000 0.262329
			v 0.147231 1.010000 0.255026
			v 0.262313 1.000000 0.158630
			v 0.255010 1.010000 0.147248
			v 0.304813 1.000000 0.000019
			v 0.294460 1.010000 0.000019
			v 0.262312 1.000000 -0.158591
			v 0.255010 1.010000 -0.147209
			v 0.158613 1.000000 -0.262291
			v 0.147231 1.010000 -0.254988
			v 0.490000 0.000000 -0.490000
			v 0.490000 0.000000 0.490000
			v -0.490000 0.000000 0.490000
			v -0.490000 0.000000 -0.490000
			v 0.500000 0.990000 -0.490000
			v 0.490000 0.990000 -0.500000
			v 0.490000 0.990000 0.500000
			v 0.500000 0.990000 0.490000
			v -0.500000 0.990000 0.490000
			v -0.490000 0.990000 0.500000
			v -0.490000 0.990000 -0.500000
			v -0.500000 0.990000 -0.490000
			v 0.490000 0.010000 -0.500000
			v 0.500000 0.010000 -0.490000
			v 0.500000 0.010000 0.490000
			v 0.490000 0.010000 0.500000
			v -0.490000 0.010000 0.500000
			v -0.500000 0.010000 0.490000
			v -0.500000 0.010000 -0.490000
			v -0.490000 0.010000 -0.500000
			vn 0.3416 0.8756 0.3416
			vn 0.8756 0.3416 -0.3416
			vn 0.3416 0.8756 -0.3416
			vn 0.7904 0.4435 0.4225
			vn 0.4646 0.3692 0.8048
			vn 0.4225 0.4434 0.7904
			vn 0.0000 0.3692 0.9293
			vn 0.0000 0.4159 0.9094
			vn 0.9094 0.4159 0.0000
			vn 0.8048 0.3692 0.4646
			vn -0.4646 0.3692 0.8048
			vn -0.4225 0.4434 0.7904
			vn 0.7904 0.4434 -0.4225
			vn 0.9293 0.3692 0.0000
			vn 0.4225 0.4434 -0.7904
			vn 0.8048 0.3692 -0.4646
			vn -0.8048 0.3692 0.4646
			vn -0.7904 0.4434 0.4225
			vn -0.9293 0.3692 0.0000
			vn -0.9094 0.4159 0.0000
			vn -0.8048 0.3692 -0.4646
			vn -0.7904 0.4434 -0.4225
			vn 0.0000 0.4159 -0.9094
			vn 0.4646 0.3692 -0.8048
			vn 0.8756 -0.3416 0.3416
			vn 0.8756 -0.3416 -0.3416
			vn 0.3416 -0.3416 -0.8756
			vn -0.3416 0.3416 -0.8756
			vn 0.3416 0.3416 -0.8756
			vn 0.3416 0.3416 0.8756
			vn -0.3416 -0.3416 0.8756
			vn 0.3416 -0.3416 0.8756
			vn -0.8756 0.3416 0.3416
			vn -0.8756 -0.3416 -0.3416
			vn -0.8756 -0.3416 0.3416
			vn -0.3416 -0.8756 -0.3416
			vn 0.3416 -0.8756 -0.3416
			vn -0.3416 0.8756 -0.3416
			vn -0.3416 0.8756 0.3416
			vn -0.4646 0.3692 -0.8048
			vn -0.4225 0.4434 -0.7904
			vn 0.0000 0.9048 -0.4257
			vn -0.2128 0.9048 -0.3687
			vn -0.3687 0.9048 -0.2128
			vn -0.4257 0.9048 0.0000
			vn -0.3687 0.9048 0.2128
			vn -0.2128 0.9048 0.3687
			vn 0.0000 0.9048 0.4257
			vn 0.2128 0.9048 0.3687
			vn 0.3687 0.9048 0.2128
			vn 0.4257 0.9048 0.0000
			vn 0.3687 0.9048 -0.2128
			vn 0.2128 0.9048 -0.3687
			vn 0.0000 0.3692 -0.9293
			vn 0.0000 0.9478 -0.3186
			vn -0.1542 0.9591 -0.2374
			vn -0.2374 0.9591 -0.1542
			vn -0.3186 0.9478 0.0000
			vn -0.2374 0.9591 0.1542
			vn -0.1542 0.9591 0.2374
			vn 0.0000 0.9478 0.3186
			vn 0.1542 0.9591 0.2374
			vn 0.2374 0.9591 0.1542
			vn 0.3186 0.9478 0.0000
			vn 0.2374 0.9591 -0.1542
			vn 0.1542 0.9591 -0.2374
			vn -0.3416 -0.8756 0.3416
			vn 0.3416 -0.8756 0.3416
			vn 0.8756 0.3416 0.3416
			vn -0.3416 0.3416 0.8756
			vn -0.8756 0.3416 -0.3416
			vn -0.3416 -0.3416 -0.8756
			s 1
			f 2//1 57//2 1//3
			f 46//4 19//5 44//6
			f 44//6 17//7 42//8
			f 48//9 21//10 46//4
			f 42//8 15//11 40//12
			f 50//13 23//14 48//9
			f 52//15 25//16 50//13
			f 40//12 13//17 38//18
			f 38//18 11//19 36//20
			f 36//20 9//21 34//22
			f 29//23 27//24 52//15
			f 57//2 67//25 66//26
			f 65//27 63//28 58//29
			f 59//30 69//31 68//32
			f 61//33 71//34 70//35
			f 56//36 65//27 53//37
			f 4//38 61//33 3//39
			f 34//22 7//40 32//41
			f 5//42 7//40 8//43
			f 10//44 7//40 9//21
			f 10//44 11//19 12//45
			f 14//46 11//19 13//17
			f 14//46 15//11 16//47
			f 16//47 17//7 18//48
			f 18//48 19//5 20//49
			f 20//49 21//10 22//50
			f 22//50 23//14 24//51
			f 24//51 25//16 26//52
			f 28//53 25//16 27//24
			f 28//53 6//54 5//42
			f 32//41 30//55 31//56
			f 32//41 33//57 34//22
			f 34//22 35//58 36//20
			f 38//18 35//58 37//59
			f 38//18 39//60 40//12
			f 40//12 41//61 42//8
			f 44//6 41//61 43//62
			f 46//4 43//62 45//63
			f 46//4 47//64 48//9
			f 50//13 47//64 49//65
			f 52//15 49//65 51//66
			f 52//15 30//55 29//23
			f 32//41 6//54 29//23
			f 31//56 30//55 4//38
			f 31//56 4//38 33//57
			f 3//39 35//58 4//38
			f 49//65 47//64 1//3
			f 49//65 1//3 51//66
			f 51//66 1//3 30//55
			f 35//58 33//57 4//38
			f 47//64 2//1 1//3
			f 37//59 35//58 3//39
			f 2//1 47//64 45//63
			f 39//60 37//59 3//39
			f 2//1 45//63 43//62
			f 41//61 39//60 3//39
			f 2//1 43//62 41//61
			f 2//1 41//61 3//39
			f 30//55 1//3 4//38
			f 68//32 55//67 54//68
			f 66//26 54//68 53//37
			f 70//35 56//36 55//67
			f 3//39 59//30 2//1
			f 57//2 58//29 1//3
			f 59//30 60//69 2//1
			f 61//33 62//70 3//39
			f 63//28 64//71 4//38
			f 65//27 66//26 53//37
			f 67//25 68//32 54//68
			f 69//31 70//35 55//67
			f 71//34 72//72 56//36
			f 58//29 66//26 65//27
			f 68//32 60//69 59//30
			f 64//71 72//72 71//34
			f 70//35 62//70 61//33
			f 58//29 4//38 1//3
			f 28//53 5//42 8//43
			f 26//52 28//53 8//43
			f 26//52 8//43 10//44
			f 26//52 10//44 12//45
			f 24//51 26//52 12//45
			f 24//51 12//45 14//46
			f 22//50 24//51 14//46
			f 22//50 14//46 16//47
			f 20//49 22//50 16//47
			f 20//49 16//47 18//48
			f 56//36 54//68 55//67
			f 2//1 60//69 57//2
			f 46//4 21//10 19//5
			f 44//6 19//5 17//7
			f 48//9 23//14 21//10
			f 42//8 17//7 15//11
			f 50//13 25//16 23//14
			f 52//15 27//24 25//16
			f 40//12 15//11 13//17
			f 38//18 13//17 11//19
			f 36//20 11//19 9//21
			f 29//23 6//54 27//24
			f 57//2 60//69 67//25
			f 65//27 72//72 63//28
			f 59//30 62//70 69//31
			f 61//33 64//71 71//34
			f 56//36 72//72 65//27
			f 4//38 64//71 61//33
			f 34//22 9//21 7//40
			f 5//42 6//54 7//40
			f 10//44 8//43 7//40
			f 10//44 9//21 11//19
			f 14//46 12//45 11//19
			f 14//46 13//17 15//11
			f 16//47 15//11 17//7
			f 18//48 17//7 19//5
			f 20//49 19//5 21//10
			f 22//50 21//10 23//14
			f 24//51 23//14 25//16
			f 28//53 26//52 25//16
			f 28//53 27//24 6//54
			f 32//41 29//23 30//55
			f 32//41 31//56 33//57
			f 34//22 33//57 35//58
			f 38//18 36//20 35//58
			f 38//18 37//59 39//60
			f 40//12 39//60 41//61
			f 44//6 42//8 41//61
			f 46//4 44//6 43//62
			f 46//4 45//63 47//64
			f 50//13 48//9 47//64
			f 52//15 50//13 49//65
			f 52//15 51//66 30//55
			f 32//41 7//40 6//54
			f 68//32 69//31 55//67
			f 66//26 67//25 54//68
			f 70//35 71//34 56//36
			f 3//39 62//70 59//30
			f 58//29 57//2 66//26
			f 68//32 67//25 60//69
			f 64//71 63//28 72//72
			f 70//35 69//31 62//70
			f 58//29 63//28 4//38
			f 56//36 53//37 54//68
		</script>
		<script id="cube" type="text/plain">
			v 0.0 0.0 0.0
			v 0.0 0.0 1.0
			v 0.0 1.0 0.0
			v 0.0 1.0 1.0
			v 1.0 0.0 0.0
			v 1.0 0.0 1.0
			v 1.0 1.0 0.0
			v 1.0 1.0 1.0
			vn 0.0 0.0 1.0
			vn 0.0 0.0 -1.0
			vn 0.0 1.0 0.0
			vn 0.0 -1.0 0.0
			vn 1.0 0.0 0.0
			vn -1.0 0.0 0.0
			f 1//2 7//2 5//2
			f 1//2 3//2 7//2
			f 1//6 4//6 3//6
			f 1//6 2//6 4//6
			f 3//3 8//3 7//3
			f 3//3 4//3 8//3
			f 5//5 7//5 8//5
			f 5//5 8//5 6//5
			f 1//4 5//4 6//4
			f 1//4 6//4 2//4
			f 2//1 6//1 8//1
			f 2//1 8//1 4//1
		</script>
		<script type="text/javascript" src="./glfx.js"></script>
		<script type="text/javascript">
			var PALETTES = {
				DB16: [
					0x140C1C,
					0x442434,
					0x30346D,
					0x4E4A4F,
					0x854C30,
					0x346524,
					0xD04648,
					0x757161,
					0x597DCE,
					0xD27D2C,
					0x8595A1,
					0x6DAA2C,
					0xD2AA99,
					0x6DC2CA,
					0xDAD45E,
					0xDEEED6
				],
				PICO8: [
					0x000000,
					0x1D2B53,
					0x7E2553,
					0x008751,
					0xAB5236,
					0x5F574F,
					0xC2C3C7,
					0xFFF1E8,
					0xFF004D,
					0xFFA300,
					0xFFEC27,
					0x00E436,
					0x29ADFF,
					0x83769C,
					0xFF77A8,
					0xFFCCAA
				]
			};

			var bmat4x4 = [
				0, 8, 2, 10,
				12, 4, 14, 6,
				3, 11, 1, 9,
				15, 7, 13, 5
			];

			var bmat3x3 = [
				0, 7, 3,
				6, 5, 2,
				4, 1, 8
			];

			var palettesSel = document.getElementById("palettes");
			Object.keys(PALETTES).forEach(function(key) {
				var opt = document.createElement('option');
				opt.value = key;
				opt.innerHTML = key;
				palettesSel.appendChild(opt);
			});

			GLFX.createContext("pb");
			var gl = GLFX.GL;
			var canvas = GLFX.Canvas;

			var fov = 40.0;

			var image = null;
			var imageValid = false;
			var bricksMap = [];
			var bricksRenderMap = [];
			var progress = 0;
			var palette = null;

			var brick = GLFX.Mesh.fromOBJ(document.getElementById("brick").innerHTML);
			var shader = GLFX.Shader.fromHTMLElement("brick_vs", "brick_fs");

			var lightDir = new GLFX.Vec3(-1.0, -1.0, -1.0);
			var proj = GLFX.Mat4.perspective(Math.radians(fov), 1.0, 0.01, 1000.0);
			var view = GLFX.Mat4.ident();

			var pivot = GLFX.Mat4.rotationX(Math.radians(-90)).mul(GLFX.Mat4.rotationY(Math.radians(-45)));
			var cameraT = GLFX.Mat4.translation(0, 0, -50);

			$("#palettes").change(function() {
				palette = PALETTES[this.value];
			});

			$("#file").change(function() {
				if (this.files && this.files[0]) {
					var reader = new FileReader();
					reader.onload = function(e) {
						image = new Image();
						image.onload = function() {
							imageValid = true;
						};
						image.src = e.target.result;
						$("#out_preview").attr("src", e.target.result);
					};
					reader.readAsDataURL(this.files[0]);
				}
			});

			$("#in_url").on('input', function() {
				if (this.value.length > 0) {
					var img = new Image();
					img.onload = function() {
						imageValid = true;
						image = img;
						$("#out_preview").attr("src", this.value.length);
					};
					img.src = this.value;
				}
			});

			function findScale(w, h, tw, th) {
				// We'll either to match `xSize` to `xGoal` or `ySize` to `yGoal` so
				// compute a scale for each.
				var xScale = tw / w;
				var yScale = th / h;

				// If xScale makes it too tall we'll have to use yScale
				// and if yScale makes it too wide we'll have to use xScale
				if ( xScale * h > th ) {
					return yScale;
				} else {
					return xScale;
				}
			}

			function rgb(hex) {
				let r = (hex & 0xFF0000) >> 16;
				let g = (hex & 0x00FF00) >> 8;
				let b = (hex & 0x0000FF);
				return [r, g, b];
			}

			function closestColor(r, g, b, palette) {
				var closestDist = Number.MAX_VALUE;
				var closest = 0;
				for (var i = 0; i < palette.length; i++) {
					var col = rgb(palette[i]);
					var dr = Math.abs(r - col[0]);
					var dg = Math.abs(g - col[1]);
					var db = Math.abs(b - col[2]);
					var d = Math.sqrt(dr*dr+dg*dg+db*db);
					if (d < closestDist) {
						closestDist = d;
						closest = i;
					}
				}
				return closest;
			}

			function dither(comp, x, y, bmat, matSize) {
				let dx = x % matSize;
				let dy = y % matSize;
				let dt = bmat[dx + dy * matSize] / (matSize * matSize);
				let p = comp / 255.0;
				return ~~((p + (p * dt)) * 255.0);
			}

			$("#btn_gen").click(function() {
				if (!imageValid) {
					alert("Please select a valid image.");
					return;
				}
				$("#gen_loader").addClass("active");

				// First reduce the image
				var canvas = document.createElement("canvas");
				var ctx = canvas.getContext("2d");
				ctx.mozImageSmoothingEnabled = false;
				ctx.webkitImageSmoothingEnabled = false;
				ctx.imageSmoothingEnabled = false;
				var scale = 1.0;
				if (image.width > 64 && image.height > 64) {
					scale = findScale(image.width, image.height, 64, 64);
				}
				var nw = ~~(image.width * scale);
				var nh = ~~(image.height * scale);
				canvas.width = nw;
				canvas.height = nh;
				ctx.drawImage(image, 0, 0, nw, nh);

				// Quantization
				if (document.getElementById("chk_colorquant").checked && palette !== null) {
					var data = ctx.createImageData(nw, nh);
					for (var y = 0; y < nh; y++) {
						for (var x = 0; x < nw; x++) {
							var col = ctx.getImageData(x, y, 1, 1).data;
							var or = dither(col[0], x, y, bmat3x3, 3);
							var og = dither(col[1], x, y, bmat3x3, 3);
							var ob = dither(col[2], x, y, bmat3x3, 3);
							var pcol = rgb(palette[closestColor(or, og, ob, palette)]);
							var i = (x + y * nw) * 4;
							data.data[i + 0] = pcol[0];
							data.data[i + 1] = pcol[1];
							data.data[i + 2] = pcol[2];
							data.data[i + 3] = col[3];
						}
					}
					ctx.putImageData(data, 0, 0);
				}

				// Then process it
				bricksMap = [];
				for (var y = 0; y < nh; y++) {
					for (var x = 0; x < nw; x++) {
						var c = ctx.getImageData(x, y, 1, 1).data;
						if (c[3] > 0) {
							var b = {
								pos: new GLFX.Vec3(x - (nw/2), 0, y - (nh/2)),
								col: new GLFX.Vec3(c[0]/255, c[1]/255, c[2]/255),
								y: 400
							};
							bricksMap.push(b);

							$(b).animate({
								y: 0
							}, {
								duration: ~~(200 + Math.random() * 1500),
								easing: 'swing'
							});
						}
					}
				}

				$("#gen_loader").removeClass("active");
			});

			gl.enable(gl.DEPTH_TEST);
			gl.enable(gl.CULL_FACE);

			window.onresize = function(e) {
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
				proj = GLFX.Mat4.perspective(Math.radians(fov), canvas.width/canvas.height, 0.01, 1000.0);
				gl.viewport(0, 0, canvas.width, canvas.height);
			};
			window.onresize(null);

			var mx, my, mpx, mpy, mdx, mdy;
			var rotating = false;
			canvas.onmousedown = function(evt) {
				var rect = canvas.getBoundingClientRect();
				mx = evt.clientX - rect.left;
				my = evt.clientY - rect.top;
				mpx = mx;
				mpy = my;
				rotating = true;
			};

			canvas.onmousemove = function(evt) {
				if (rotating) {
					var rect = canvas.getBoundingClientRect();
					mx = evt.clientX - rect.left;
					my = evt.clientY - rect.top;
					mdx = mx - mpx;
					mdy = my - mpy;
					mpx = mx;
					mpy = my;

					pivot = pivot.mul(GLFX.Mat4.rotationX(-mdy * 0.01));
					pivot = pivot.mul(GLFX.Mat4.rotationY(mdx * 0.01));
				}
			};

			canvas.onmouseup = function(evt) {
				rotating = false;
			};

			canvas.onmousewheel = function(e) {
				var delta = Math.max(-1, Math.min(1, (e.wheelDelta || -e.detail)));
				cameraT = cameraT.mul(GLFX.Mat4.translation(0, 0, delta * 0.4));
			};

			function mainLoop() {
				view = pivot.mul(cameraT);

				gl.clearColor(0, 0.25, 0.5, 1.0);
				gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

				shader.bind();
				shader.getUniform("mProjection").setMat4(proj);
				shader.getUniform("mView").setMat4(view);
				shader.getUniform("uLightDir").setVec3(lightDir);

				brick.bind(shader);
				for (var b of bricksMap) {
					shader.getUniform("mModel").setMat4(GLFX.Mat4.translation(b.pos.x, b.y, b.pos.z));
					shader.getUniform("uColor").setVec3(b.col);
					brick.render(gl.TRIANGLES);
				}
				brick.unbind();

				GLFX.nextFrame(mainLoop);
			}
			mainLoop();
		</script>
	</body>
</html>